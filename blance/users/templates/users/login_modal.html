<!-- users/templates/users/login_modal.html -->
{% block register %}
<div id="modal" class="modal">
    <div class="modal-content">

        <div class="modal-header">
            <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</h2>
            <span class="close-btn" onclick="closeModal()">&times;</span>
        </div>

        <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥—É —á–µ—Ä–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω -->
        <form id="phoneForm" method="POST" action="#" class="modal-form active-form">
            {% csrf_token %}
            <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input type="tel" name="phone" id="phone" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É" required autocomplete="off">
            <input type="hidden" name="next" value="{{ next }}"/>
            <label for="phone-password">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" name="password" id="phone-password" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å" required autocomplete="off">
            <button type="submit" class="modal-btn">–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
            <div class="divider">
                <span class="divider__text">–∞–±–æ</span>
            </div>
            <div class="login-options">
                    <button type="button" style="width:100%; text-decoration: none;" onclick="handleGoogleLogin()" class="google-login-btn button1 button--medium button--gray button--with-icon">
                        <svg width="24" height="24">
                            <use href="#google-icon"></use>
                        </svg>
                        <a href="{% url 'users:google_login' %}" style="color: #3e77aa; margin: 0 0px;">
                            Google
                        </a>
                    </button>
                <button type="button" style="width:100%; text-decoration: none;" class="facebook-login-btn button1 button--medium button--gray button--with-icon">
                    <svg width="24" height="24">
                        <use href="#facebook-icon"></use>
                    </svg>
                    Facebook
                </button>
            </div>
            <button type="button" style="width:100%;" id="switchToEmail" class="button1 button--medium button--link link-button">
                –ê–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è —á–µ—Ä–µ–∑ –ø–æ—à—Ç—É
            </button>
            <button type="button" style="width:100%;" class="button1 button--medium button--link link-button" onclick="switchToRegisterForm();">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
            <button type="button" style="width:100%;" class="button1 button--medium button--link link-button" onclick="switchToForgotPasswordForm();">–ó–∞–±—É–ª–∏ –ø–∞—Ä–æ–ª—å?</button>

        </form>

        {% if form.errors %}
            <p style="color: red;">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å</p>
        {% endif %}

        <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥—É —á–µ—Ä–µ–∑ –ø–æ—à—Ç—É -->
        <form id="emailForm" method="POST" action="#" class="modal-form">
            {% csrf_token %}
            <label for="email">–ï–ª. –ø–æ—à—Ç–∞</label>
            <input type="email" name="email" id="email" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ—à—Ç—É" required autocomplete="off">
            <input type="hidden" name="next" value="{{ next }}"/>
            <label for="phone-password">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" name="password" id="email-password" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å" required autocomplete="off">
            <button type="submit" class="modal-btn">–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
            <div class="divider">
                <span class="divider__text">–∞–±–æ</span>
            </div>
            <div class="login-options">
                    <button type="button" style="width:100%; text-decoration: none;" onclick="handleGoogleLogin()" class="google-login-btn button1 button--medium button--gray button--with-icon">
                        <svg width="24" height="24">
                            <use href="#google-icon"></use>
                        </svg>
                        <a href="{% url 'users:google_login' %}" style="color: #3e77aa; margin: 0 0px;">
                            Google
                        </a>
                    </button>
                <button type="button" style="width:100%; text-decoration: none;" class="facebook-login-btn button1 button--medium button--gray button--with-icon">
                    <svg width="24" height="24">
                        <use href="#facebook-icon"></use>
                    </svg>
                    Facebook
                </button>
            </div>
            <button type="button" style="width:100%;" id="switchToPhone" class="button1 button--medium button--link link-button">
                –ê–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è —á–µ—Ä–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω
            </button>
            <button type="button" style="width:100%;" class="button1 button--medium button--link link-button" onclick="switchToRegisterForm();">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
            <button type="button" style="width:100%;" class="button1 button--medium button--link link-button" onclick="switchToForgotPasswordForm();">–ó–∞–±—É–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
        </form>

        {% if form.errors %}
            <p style="color: red;">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å</p>
        {% endif %}

        <!-- –§–æ—Ä–º–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω -->
        <form id="phoneRegisterForm" class="modal-form" autocomplete="off">
            {% csrf_token %}
            <label for="phoneRegister">–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input type="text" id="phoneRegister" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É" required autocomplete="off">
            <input type="hidden" name="next" value="{{ next }}"/>
            <label for="phonePassword">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="phonePassword" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å" required autocomplete="off">
            <button type="submit" class="modal-btn">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
            <div class="divider">
                <span class="divider__text">–∞–±–æ</span>
            </div>
            <div class="login-options">
                <button type="button" style="width:100%; text-decoration: none;" onclick="handleGoogleLogin()" class="google-login-btn button1 button--medium button--gray button--with-icon">
                    <svg width="24" height="24">
                        <use href="#google-icon"></use>
                    </svg>
                    <a href="{% url 'users:google_login' %}" style="color: #3e77aa; margin: 0 0px;">
                        Google
                    </a>
                </button>
                <button type="submit" style="width:100%; text-decoration: none;" class="facebook-login-btn button1 button--medium button--gray button--with-icon">
                    <svg width="24" height="24">
                        <use href="#facebook-icon"></use>
                    </svg>
                    Facebook
                </button>
            </div>
            <button type="button" style="width:100%;" id="switchToEmailRegister" class="button1 button--medium button--link link-button-register">
                –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è —á–µ—Ä–µ–∑ –ø–æ—à—Ç—É
            </button>
            <button style="width:100%;" class="button1 button--medium button--link link-button"
                onclick="switchToLoginForm();">
                –ê–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è
            </button>
        </form>

        <!-- –§–æ—Ä–º–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ –ø–æ—à—Ç—É -->
        <form id="emailRegisterForm" class="modal-form" autocomplete="off">
            {% csrf_token %}
            <label for="emailRegister">–ï–ª. –ø–æ—à—Ç–∞</label>
            <input type="email" id="emailRegister" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ—à—Ç—É" required autocomplete="off">
            <input type="hidden" name="next" value="{{ next }}"/>
            <label for="emailPassword">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="emailPassword" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å" required autocomplete="off">
            <button type="submit" class="modal-btn">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
            <div class="divider">
                <span class="divider__text">–∞–±–æ</span>
            </div>
            <div class="login-options">
                <button type="button" style="width:100%; text-decoration: none;" onclick="handleGoogleLogin()" class="google-login-btn button1 button--medium button--gray button--with-icon">
                    <svg width="24" height="24">
                        <use href="#google-icon"></use>
                    </svg>
                    <a href="{% url 'users:google_login' %}" style="color: #3e77aa; margin: 0 0px;">
                        Google
                    </a>
                </button>
                <button type="submit" style="width:100%; text-decoration: none;" class="facebook-login-btn button1 button--medium button--gray button--with-icon">
                    <svg width="24" height="24">
                        <use href="#facebook-icon"></use>
                    </svg>
                    Facebook
                </button>
            </div>
            <button type="button" style="width:100%;" id="switchToPhoneRegister" class="button1 button--medium button--link link-button-register">
                –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è —á–µ—Ä–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω
            </button>
            <button style="width:100%;" class="button1 button--medium button--link link-button"
                onclick="switchToLoginForm();">
                –ê–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è
            </button>
        </form>
        <form id="forgotPasswordForm" class="modal-form" autocomplete="off">
            <label for="forgotEmail">Email</label>
            <input type="email" id="forgotEmail" required>
            <button type="submit" class="modal-btn">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</button>
             <div class="divider">
                <span class="divider__text">–∞–±–æ</span>
            </div>
            <button style="width:100%;" class="button1 button--medium button--link link-button"
                onclick="switchBackToLoginAfterRecovery();">
                –ê–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è
            </button>
        </form>
    </div>
</div>
<script>
    // –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è/–∑–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
    function openModal() {
        const modal = document.getElementById("modal");
        modal.classList.add("show"); // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
    }

    function closeModal() {
        const modal = document.getElementById("modal");
        modal.classList.remove("show"); // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
    }

    // –ó–∞–∫—Ä–∏—Ç—Ç—è –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –º–æ–¥–∞–ª—å–Ω–∏–º –≤—ñ–∫–Ω–æ–º
    window.onclick = function (event) {
        const modal = document.getElementById("modal");
        if (event.target === modal) {
            closeModal();
        }
    };

    function updateProfileButton() {
        const profileButton = document.querySelector(".profile");
        const jwt = localStorage.getItem("jwt");
        const isResetPage = window.location.pathname.includes("/api/password/reset_page/");

        if (!profileButton) return;

        if (isResetPage) {
            profileButton.textContent = "–ü—Ä–æ—Ñ—ñ–ª—å";
            profileButton.style.pointerEvents = "none";
            profileButton.style.opacity = "0.5";
            profileButton.style.cursor = "default";
            return;
        }
        if (jwt) {
            profileButton.innerHTML = `<div class="dropdown">
                <div class="dropdown-content">
                    <a href="#" id="logout">–í–∏–π—Ç–∏</a>
                </div>
            </div>`;
            document.getElementById("logout").addEventListener("click", logoutUser);
        }
    }

    function logoutUser() {
        localStorage.removeItem("jwt");
        location.reload();
    }

    document.addEventListener("DOMContentLoaded", updateProfileButton);

    // –§—É–Ω–∫—Ü—ñ—è –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ–π–Ω—ñ —Ñ–æ—Ä–º–∏
    function switchToRegisterForm() {
        const PhoneForm = document.getElementById("phoneForm");
        const EmailForm = document.getElementById("emailForm");
        const phoneRegisterForm = document.getElementById("phoneRegisterForm");
        const emailRegisterForm = document.getElementById("emailRegisterForm");
        const modalTitle = document.querySelector(".modal-header h2"); // –û—Ç—Ä–∏–º—É—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫

        // –Ø–∫—â–æ –∞–∫—Ç–∏–≤–Ω–∞ —Ñ–æ—Ä–º–∞ –≤—Ö–æ–¥—É —á–µ—Ä–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω
        if (phoneForm && phoneForm.classList.contains("active-form")) {
            phoneForm.classList.remove("active-form");
            phoneRegisterForm.classList.add("active-form");
            modalTitle.textContent = "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è";
            phoneRegisterForm.querySelectorAll('input').forEach(input => input.value = "");
        }
        // –Ø–∫—â–æ –∞–∫—Ç–∏–≤–Ω–∞ —Ñ–æ—Ä–º–∞ –≤—Ö–æ–¥—É —á–µ—Ä–µ–∑ email
        else if (emailForm && emailForm.classList.contains("active-form")) {
            emailForm.classList.remove("active-form");
            emailRegisterForm.classList.add("active-form");
            modalTitle.textContent = "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è";
            emailRegisterForm.querySelectorAll('input').forEach(input => input.value = "");
        }


        document.activeElement.blur();
    }

    // –§—É–Ω–∫—Ü—ñ—è –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –Ω–∞ —Ñ–æ—Ä–º–∏ –≤—Ö–æ–¥—É (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–∞)
    function switchToLoginForm() {
        const phoneForm = document.getElementById("phoneForm");
        const emailForm = document.getElementById("emailForm");
        const phoneRegisterForm = document.getElementById("phoneRegisterForm");
        const emailRegisterForm = document.getElementById("emailRegisterForm");
        const forgotPasswordForm = document.getElementById("forgotPasswordForm");
        const resetPasswordForm = document.getElementById("resetPasswordForm");
        const modalTitle = document.querySelector(".modal-header h2");

        // –Ø–∫—â–æ –∞–∫—Ç–∏–≤–Ω–∞ —Ñ–æ—Ä–º–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω
        if (phoneRegisterForm && phoneRegisterForm.classList.contains("active-form")) {
            phoneRegisterForm.classList.remove("active-form");
            phoneForm.classList.add("active-form");
            modalTitle.textContent = "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è";
        }
        // –Ø–∫—â–æ –∞–∫—Ç–∏–≤–Ω–∞ —Ñ–æ—Ä–º–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ email
        else if (emailRegisterForm && emailRegisterForm.classList.contains("active-form")) {
            emailRegisterForm.classList.remove("active-form");
            emailForm.classList.add("active-form");
            modalTitle.textContent = "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è";
        }
        document.activeElement.blur();
    }


    function switchToForgotPasswordForm() {
        const phoneForm = document.getElementById("phoneForm");
        const emailForm = document.getElementById("emailForm");
        const phoneRegisterForm = document.getElementById("phoneRegisterForm");
        const emailRegisterForm = document.getElementById("emailRegisterForm");
        const forgotPasswordForm = document.getElementById("forgotPasswordForm");
        const modalTitle = document.querySelector(".modal-header h2");

        // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤—Å—ñ —Ñ–æ—Ä–º–∏
        [phoneForm, emailForm, phoneRegisterForm, emailRegisterForm].forEach(form => {
            if (form) form.classList.remove("active-form");
        });

        // –ü–æ–∫–∞–∑—É—î–º–æ —Ñ–æ—Ä–º—É "–ó–∞–±—É–ª–∏ –ø–∞—Ä–æ–ª—å?"
        forgotPasswordForm.classList.add("active-form");
        modalTitle.textContent = "–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–∞—Ä–æ–ª—è";

        document.activeElement.blur();
    }

    function hideAllForms() {
        const forms = document.querySelectorAll('.modal-form');
        forms.forEach(form => form.classList.remove('active-form'));
    }

    function switchBackToLoginAfterRecovery() {
        const forgotPasswordForm = document.getElementById("forgotPasswordForm");
        const phoneForm = document.getElementById("phoneForm");
        const emailForm = document.getElementById("emailForm");
        const modalTitle = document.querySelector(".modal-header h2");

        // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ —Ñ–æ—Ä–º—É –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è
        forgotPasswordForm.classList.remove("active-form");

        // –ü–æ–∫–∞–∑—É—î–º–æ —Ñ–æ—Ä–º—É –≤—Ö–æ–¥—É ‚Äî —Ç–∏ –º–æ–∂–µ—à –≤–∏–±—Ä–∞—Ç–∏, —è–∫–∞ —Å–∞–º–µ –º–∞—î –±—É—Ç–∏ –æ—Å–Ω–æ–≤–Ω–æ—é (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, phoneForm)
        phoneForm.classList.add("active-form");

        // –ó–º—ñ–Ω—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫
        modalTitle.textContent = "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è";

        document.activeElement.blur();
    }



    // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –º—ñ–∂ –æ–∫—Ä–µ–º–∏–º–∏ –≤–∞—Ä—ñ–∞–Ω—Ç–∞–º–∏ –≤—Ö–æ–¥—É —Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
    document.addEventListener("DOMContentLoaded", function () {
        const switchToEmail = document.getElementById("switchToEmail");
        const switchToPhone = document.getElementById("switchToPhone");
        const switchToEmailRegister = document.getElementById("switchToEmailRegister");
        const switchToPhoneRegister = document.getElementById("switchToPhoneRegister");
        const phoneForm = document.getElementById("phoneForm");
        const emailForm = document.getElementById("emailForm");
        const phoneRegisterForm = document.getElementById("phoneRegisterForm");
        const emailRegisterForm = document.getElementById("emailRegisterForm");

        // –ü–µ—Ä–µ–º–∏–∫–∞—î–º–æ—Å—è –º—ñ–∂ —Ñ–æ—Ä–º–∞–º–∏ –≤—Ö–æ–¥—É
        switchToEmail.addEventListener("click", () => {
            phoneForm.classList.remove("active-form");
            emailForm.classList.add("active-form");
        });

        switchToPhone.addEventListener("click", () => {
            emailForm.classList.remove("active-form");
            phoneForm.classList.add("active-form");
        });

        // –ü–µ—Ä–µ–º–∏–∫–∞—î–º–æ—Å—è –º—ñ–∂ —Ñ–æ—Ä–º–∞–º–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
        switchToEmailRegister.addEventListener("click", () => {
            phoneRegisterForm.classList.remove("active-form");
            emailRegisterForm.classList.add("active-form");
        });

        switchToPhoneRegister.addEventListener("click", () => {
            emailRegisterForm.classList.remove("active-form");
            phoneRegisterForm.classList.add("active-form");
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const forgotPasswordLink = document.getElementById("forgotPasswordLink");
        if (forgotPasswordLink) {
            forgotPasswordLink.addEventListener("click", switchToForgotPasswordForm);
        }

        // üëá –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–∫—É –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è —Ñ–æ—Ä–º–∏
        const forgotPasswordForm = document.getElementById("forgotPasswordForm");
        if (forgotPasswordForm) {
            forgotPasswordForm.addEventListener("submit", function (event) {
                event.preventDefault();

                const email = document.getElementById("forgotEmail").value;

                fetch("/api/password/forgot/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ email: email }),
                })
                .then((response) => response.json())
                .then((data) => {
                    alert("–ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–∞—Ä–æ–ª—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ!");
                    switchBackToLoginAfterRecovery();
                })
                .catch((error) => {
                    console.error("–ü–æ–º–∏–ª–∫–∞:", error);
                    alert("–©–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.");
                });
            });
        }
    });


    document.getElementById("google-login-btn").addEventListener("click", function () {
        window.location.href = "api/auth/google/callback/";
    });
</script>
<script>
    function getCSRFToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        return csrfToken;
    }

    document.getElementById('phoneRegisterForm').addEventListener('submit', function(event) {
        event.preventDefault(); // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—é —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        clearErrors();

        const phone = document.getElementById('phoneRegister').value.trim();
        const password = document.getElementById('phonePassword').value.trim();

        // –í–∏–∫–æ–Ω—É—î–º–æ AJAX –∑–∞–ø–∏—Ç –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
        fetch('/api/register/phone/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken() // –¥–æ–¥–∞—Ç–∏ CSRF —Ç–æ–∫–µ–Ω
            },
            body: JSON.stringify({ phone: phone, password: password })
        })
        .then(response => response.json())
        .then(data => {
            if (data.token) {
                localStorage.setItem('jwt', data.token);
                showMessage(data.success || '–í–∏ —É—Å–ø—ñ—à–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞–ª–∏—Å—å');
                setTimeout(() => {
                    closeModal();
                    updateProfileButton();
                }, 3000);
            } else if (data.email || data.phone_number) {
                if (data.email) {
                    showError('emailRegister', data.email[0]);
                    showErrorMessage(data.email[0]);
                }
                if (data.phone_number) {
                    showError('phoneRegister', data.phone_number[0]);
                    showErrorMessage(data.phone_number[0]);
                }
            } else {
                showErrorMessage('–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
            }
        })
        .catch(error => console.error('–ü–æ–º–∏–ª–∫–∞:', error));
    });

    // –î–ª—è —Ñ–æ—Ä–º–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ –ø–æ—à—Ç—É
    document.getElementById('emailRegisterForm').addEventListener('submit', function(event) {
        event.preventDefault(); // –ó–∞–ø–æ–±—ñ–≥–∞—î–º–æ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—é —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        clearErrors();

        const email = document.getElementById('emailRegister').value.trim();
        const password = document.getElementById('emailPassword').value.trim();

        // –í–∏–∫–æ–Ω—É—î–º–æ AJAX –∑–∞–ø–∏—Ç –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
        fetch('/api/register/email/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken() // –¥–æ–¥–∞—Ç–∏ CSRF —Ç–æ–∫–µ–Ω
            },
            body: JSON.stringify({ email: email, password: password })
        })
        .then(response => response.json())
        .then(data => {
            if (data.token) {
                localStorage.setItem('jwt', data.token);
                showMessage(data.success || '–í–∏ —É—Å–ø—ñ—à–Ω–æ –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞–ª–∏—Å—å');
                setTimeout(() => {
                    closeModal();
                    updateProfileButton();
                }, 3000);
            } else if (data.email || data.phone_number) {
                if (data.email) {
                    showError('emailRegister', data.email[0]);
                    showErrorMessage(data.email[0]);
                }
                if (data.phone_number) {
                    showError('phoneRegister', data.phone_number[0]);
                    showErrorMessage(data.phone_number[0]);
                }
            } else {
                showErrorMessage('–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
            }
        })
        .catch(error => console.error('–ü–æ–º–∏–ª–∫–∞:', error));
    });

    ////
    function clearErrors() {
        document.querySelectorAll('.error-message').forEach(el => el.remove());
        document.querySelectorAll('.success-message-login').forEach(el => el.remove());
    }


    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–º–∏–ª–∫–∏ –ø—ñ–¥ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–º –ø–æ–ª–µ–º
    function showError(field, message) {
        const inputField = document.getElementById(field + 'Register');
        if (inputField) {
            const errorElement = document.createElement('div');
            errorElement.className = 'error-message';
            errorElement.style.color = 'red';
            errorElement.style.fontSize = '12px';
            errorElement.textContent = message;
            inputField.parentNode.insertBefore(errorElement, inputField.nextSibling);
        }
    }

    // –û—Ç—Ä–∏–º–∞–Ω–Ω—è JWT –ø—ñ—Å–ª—è –≤—Ö–æ–¥—É
    document.getElementById('phoneForm').addEventListener('submit', function(event) {
        event.preventDefault();
        clearErrors();

        const phone = document.getElementById('phone').value.trim();
        const password = document.getElementById('phone-password').value.trim();


        fetch('/api/login/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ phone: phone, password: password })
        })
        .then(response => response.json())
        .then(data => {
            console.log("–û—Ç—Ä–∏–º–∞–Ω—ñ –¥–∞–Ω—ñ:", data);
            if (data.token) {
                localStorage.setItem('jwt', data.token);
                showMessage(data.success || '–í–∏ —É—Å–ø—ñ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞–ª–∏—Å—è');
                setTimeout(() => {
                    closeModal();
                    updateProfileButton();
                }, 3000);
            } else {
                showErrorMessage(data.error || '–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ –¥–∞–Ω—ñ');
            }
        })
        .catch(error => console.error('–ü–æ–º–∏–ª–∫–∞:', error));
    });

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    function showMessage(message) {
        const successContainer = document.createElement('div');
        successContainer.className = 'success-message';
        successContainer.textContent = message;

        // –î–æ–¥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
        const modalContent = document.querySelector('.modal-content');
        modalContent.insertBefore(successContainer, modalContent.firstChild);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ö–æ–≤–∞—î–º–æ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥–∏
        setTimeout(() => successContainer.remove(), 3000);
    }

    function showErrorMessage(message) {
        const errorContainer = document.createElement('div');
        errorContainer.className = 'error-message-login';
        errorContainer.textContent = message;

        // –î–æ–¥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
        const modalContent = document.querySelector('.modal-content');
        modalContent.insertBefore(errorContainer, modalContent.firstChild);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ö–æ–≤–∞—î–º–æ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥–∏
        setTimeout(() => errorContainer.remove(), 3000);
    }

    document.getElementById('emailForm').addEventListener('submit', function(event) {
        event.preventDefault();
        clearErrors();

        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('email-password').value.trim();

        fetch('/api/login/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ email: email, password: password })
        })
        .then(response => response.json())
        .then(data => {
            console.log("–û—Ç—Ä–∏–º–∞–Ω—ñ –¥–∞–Ω—ñ:", data);
            if (data.token) {
                localStorage.setItem('jwt', data.token);
                showMessage(data.success || '–í–∏ —É—Å–ø—ñ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞–ª–∏—Å—è');
                setTimeout(() => {
                    closeModal();
                    updateProfileButton();
                }, 3000);
            } else {
                showErrorMessage(data.error || '–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ –¥–∞–Ω—ñ');
            }
        })
        .catch(error => console.error('–ü–æ–º–∏–ª–∫–∞:', error));
    });
</script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const params = new URLSearchParams(window.location.search);
        const token = params.get("token");

        if (token) {
            localStorage.setItem("jwt", token);
            updateProfileButton();
            window.history.replaceState({}, document.title, "/");
        } else {
            updateProfileButton();
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Google OAuth
        google.accounts.id.initialize({
            client_id: "378735345784-e2f6t0m49g93h31v8tbucp6vfvb6t3t2.apps.googleusercontent.com",
            callback: handleCredentialResponse
        });

        // –ü—Ä–∏–≤'—è–∑–∫–∞ –¥–æ –≤—Å—ñ—Ö –∫–Ω–æ–ø–æ–∫ Google –≤—Ö–æ–¥—É
        document.querySelectorAll('.google-login-btn').forEach(button => {
            button.addEventListener('click', () => {
                google.accounts.id.prompt(); // –í—ñ–¥–∫—Ä–∏–≤–∞—î Google Login
            });
        });
    });

    function handleCredentialResponse(response) {
        console.log("Google Access Token:", response.credential);
        loginWithGoogle(response.credential);
    }

    function loginWithGoogle(token) {
        fetch('/api/auth/google/callback/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({ token: token })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.token) {
                localStorage.setItem('jwt', data.token);
                updateProfileButton();
            } else {
                alert("–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ Google.");
            }
        })
        .catch(error => console.error('–ü–æ–º–∏–ª–∫–∞:', error));
    }

    function getCSRFToken() {
        const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
        return tokenInput ? tokenInput.value : '';
    }
</script>
{% endblock %}